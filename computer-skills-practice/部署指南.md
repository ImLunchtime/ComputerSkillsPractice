# CentOS 8 Stream Docker部署指南

## 🎯 目标
在CentOS 8 Stream服务器上使用Docker部署计算机技能练习网站，映射5173端口并配置开机自启动。

## 📋 准备工作

### 服务器要求
- CentOS 8 Stream
- 至少2GB内存
- 至少10GB可用磁盘空间
- 网络连接正常

### 本地准备
确保项目文件完整，包括：
- ✅ Dockerfile
- ✅ docker-compose.yml
- ✅ .dockerignore
- ✅ package.json（已更新）

## 🚀 部署步骤

### 步骤1：在服务器上安装Docker

```bash
# 方法1：使用自动化脚本（推荐）
# 将 centos-docker-deploy.sh 上传到服务器并执行
chmod +x centos-docker-deploy.sh
./centos-docker-deploy.sh

# 方法2：手动安装
sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl start docker
sudo systemctl enable docker
```

### 步骤2：上传项目代码

```bash
# 在本地执行（将项目上传到服务器）
scp -r ./computer-skills-practice user@你的服务器IP:/opt/

# 或者在服务器上克隆代码
git clone 你的仓库地址 /opt/computer-skills-practice
```

### 步骤3：构建和运行容器

```bash
# 进入项目目录
cd /opt/computer-skills-practice

# 构建并启动容器
sudo docker-compose up -d

# 查看容器状态
sudo docker-compose ps

# 查看日志
sudo docker-compose logs -f
```

### 步骤4：配置开机自启动

```bash
# 启用systemd服务
sudo systemctl enable computer-skills-practice
sudo systemctl start computer-skills-practice

# 检查服务状态
sudo systemctl status computer-skills-practice
```

## 🔧 配置说明

### Docker Compose配置
- **端口映射**: 5173:5173
- **数据持久化**: ./server/data:/app/server/data
- **重启策略**: unless-stopped
- **健康检查**: 每30秒检查一次

### 环境变量
- `NODE_ENV=production`
- `npm_config_build_from_source=true`

## 🛠️ 常用命令

```bash
# 查看容器状态
sudo docker-compose ps

# 查看日志
sudo docker-compose logs -f computer-skills-practice

# 重启容器
sudo docker-compose restart

# 停止容器
sudo docker-compose down

# 重新构建并启动
sudo docker-compose up -d --build

# 进入容器
sudo docker-compose exec computer-skills-practice sh
```

## 🔍 故障排除

### 检查端口占用
```bash
sudo netstat -tlnp | grep 5173
```

### 检查防火墙
```bash
# 开放5173端口
sudo firewall-cmd --permanent --add-port=5173/tcp
sudo firewall-cmd --reload
```

### 检查SELinux
```bash
# 如果遇到权限问题，可能需要配置SELinux
sudo setsebool -P container_manage_cgroup on
```

### 查看详细日志
```bash
# 查看Docker日志
sudo journalctl -u docker

# 查看应用日志
sudo docker-compose logs --tail=100 computer-skills-practice
```

## 🌐 访问应用

部署成功后，通过以下地址访问：
- **本地访问**: http://localhost:5173
- **远程访问**: http://你的服务器IP:5173

## 📊 监控和维护

### 定期维护命令
```bash
# 清理未使用的镜像
sudo docker system prune -f

# 更新应用
cd /opt/computer-skills-practice
git pull
sudo docker-compose up -d --build

# 备份数据
sudo cp -r ./server/data ./backup-$(date +%Y%m%d)
```

### 性能监控
```bash
# 查看容器资源使用
sudo docker stats computer-skills-practice

# 查看系统资源
htop
df -h
```

## ✅ 验证部署

1. **容器运行正常**: `sudo docker-compose ps` 显示 "Up"
2. **端口监听**: `sudo netstat -tlnp | grep 5173` 有输出
3. **网页访问**: 浏览器能正常打开网站
4. **开机自启**: 重启服务器后容器自动启动

## 🆘 获取帮助

如果遇到问题，请检查：
1. Docker服务是否正常运行
2. 防火墙是否开放5173端口
3. 容器日志是否有错误信息
4. 服务器资源是否充足

---

**部署完成后，你的计算机技能练习网站就可以通过 http://你的服务器IP:5173 访问了！** 🎉